rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() {
      return request.auth != null;
    }

    function userDoc() {
      return isAuthed()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid))
        : null;
    }

    function userExists() {
      return isAuthed() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userCompanyId() {
      return userExists()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
        : null;
    }

    function userRole() {
      return userExists()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function matchesCompany(companyId) {
      return isAuthed() && companyId != null && userCompanyId() == companyId;
    }

    function isAdmin() {
      return isAuthed() && userRole() == "admin";
    }

    function isAdminOf(companyId) {
      return matchesCompany(companyId) && userRole() == "admin";
    }

    // For private company data: MUST match company, even for admins
    function canCreateForCompany(companyId) {
      return isAuthed() && matchesCompany(companyId);
    }

    function canUpdateForCompany(companyId) {
      return isAuthed()
        && matchesCompany(companyId)
        && request.resource.data.companyId == companyId
        && resource.data.companyId == companyId;
    }

    function canDeleteForCompany(companyId) {
      return isAuthed() && matchesCompany(companyId);
    }

    // ========================================================================
    // SYSTEM COLLECTIONS
    // ========================================================================

    // Companies (metadata) + nested per-company collections
    match /companies/{companyId} {
      allow read: if isAuthed();
      allow write: if isAdminOf(companyId);

      match /{sub=**} {
        allow read, write: if matchesCompany(companyId);
      }
    }

    // authorized_users: allow any signed-in user to read (for login/authorization checks)
    // This must be permissive for initial login flow before users doc exists
    match /authorized_users/{docId} {
      allow read: if isAuthed();
      allow create, update: if isAuthed()
        && request.resource.data.companyId != null
        && isAdminOf(request.resource.data.companyId);
      allow delete: if isAdminOf(resource.data.companyId);
    }

    // users: self-access only, or admins of SAME company can manage
    match /users/{uid} {
      allow read: if isAuthed() && (request.auth.uid == uid || matchesCompany(get(/databases/$(database)/documents/users/$(uid)).data.companyId));
      allow create: if isAuthed() && (
        request.auth.uid == uid ||
        (isAdmin() && request.resource.data.companyId == userCompanyId())
      );
      allow update: if isAuthed() && (
        (request.auth.uid == uid &&
         request.resource.data.companyId == resource.data.companyId &&
         request.resource.data.role == resource.data.role) ||
        (isAdmin() && matchesCompany(resource.data.companyId) && request.resource.data.companyId == resource.data.companyId)
      );
      allow delete: if isAdmin() && matchesCompany(resource.data.companyId);
    }

    // ========================================================================
    // SHARED CATALOGS: Both companies can read and write
    // (villas, cars, boats, chefs, security, services, properties)
    // ========================================================================

    // Make catalog items easier: any authenticated user can read.
    // Admins of either company can manage any shared item. Non-admins limited to their company.
    match /cars/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed();
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /villas/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed();
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /boats/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed();
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /chefs/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed() && request.resource.data.companyId != null;
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /services/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed() && request.resource.data.companyId != null;
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /serviceCategories/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed() && request.resource.data.companyId != null;
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /security/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed() && request.resource.data.companyId != null;
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    match /properties/{id} {
      allow read: if isAuthed();
      allow create: if isAuthed() && request.resource.data.companyId != null;
      allow update, delete: if isAuthed() && (isAdmin() || matchesCompany(resource.data.companyId));
    }

    // ========================================================================
    // COMPANY-PRIVATE DATA: Each company can ONLY access their own
    // (clients, reservations/bookings, offers, expenses, finances)
    // ========================================================================

    match /clients/{id} {
      // List queries MUST filter by companyId in your code: where("companyId", "==", userCompanyId)
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      allow delete: if canDeleteForCompany(resource.data.companyId);
    }

    match /reservations/{id} {
      // List queries MUST filter by companyId in your code: where("companyId", "==", userCompanyId)
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      allow delete: if canDeleteForCompany(resource.data.companyId);
    }

    match /collaborators/{id} {
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      allow delete: if canDeleteForCompany(resource.data.companyId);
    }

    match /offers/{id} {
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      allow delete: if canDeleteForCompany(resource.data.companyId);
    }

    match /expenses/{id} {
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      allow delete: if canDeleteForCompany(resource.data.companyId);
    }

    match /categoryPayments/{id} {
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      allow delete: if canDeleteForCompany(resource.data.companyId);
    }

    // Finance records: provider payouts & profit
    match /financeRecords/{id} {
      allow read: if matchesCompany(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId);
      // Some legacy records may lack companyId; allow admins of their own company to clean them up
      allow delete: if canDeleteForCompany(resource.data.companyId) ||
                    (resource.data.companyId == null && isAdmin());
    }
  }
}
