rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() {
      return request.auth != null;
    }

    function userEmail() {
      return isAuthed() && request.auth.token.email != null
        ? request.auth.token.email.lower()
        : null;
    }

    function userDoc() {
      return isAuthed()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid))
        : null;
    }

    function userExists() {
      return isAuthed() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userCompanyId() {
      return userExists()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId
        : null;
    }

    function userRole() {
      return userExists()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function matchesCompany(companyId) {
      return isAuthed() && companyId != null && userCompanyId() == companyId;
    }

    function isAdminRole(role) {
      return role in ["admin", "administrator", "owner", "manager", "superadmin"];
    }

    function isAdmin() {
      return isAuthed() && isAdminRole(userRole());
    }

    function isAdminOf(companyId) {
      return matchesCompany(companyId) && isAdminRole(userRole());
    }

    // For private company data: MUST match company, even for admins
    function canCreateForCompany(companyId) {
      return isAuthed() && matchesCompany(companyId);
    }

    function canUpdateForCompany(companyId) {
      return isAuthed()
        && matchesCompany(companyId)
        && request.resource.data.companyId == companyId
        && resource.data.companyId == companyId;
    }

    function canDeleteForCompany(companyId) {
      return isAuthed() && matchesCompany(companyId);
    }

    function canReadCompanyData(companyId) {
      return matchesCompany(companyId) || (isAdmin() && companyId == null);
    }

    function canUpdateCompanyData(companyId) {
      return canUpdateForCompany(companyId) ||
        (isAdmin() && companyId == null && request.resource.data.companyId == userCompanyId());
    }

    function canDeleteCompanyData(companyId) {
      return canDeleteForCompany(companyId) || (isAdmin() && companyId == null);
    }

    // ========================================================================
    // SYSTEM COLLECTIONS
    // ========================================================================

    // Companies (metadata) + nested per-company collections
    match /companies/{companyId} {
      allow read: if isAuthed();
      allow write: if false;

      match /{sub=**} {
        allow read, write: if matchesCompany(companyId);
      }
    }

    // authorized_users: allow any signed-in user to read (for login/authorization checks)
    // This must be permissive for initial login flow before users doc exists
    match /authorized_users/{docId} {
      // Prevent cross-company/user leakage: users can only read their own entry by email,
      // or admins can read/manage entries for their company.
      allow read: if isAuthed()
        && (resource.data.email == userEmail() || isAdminOf(resource.data.companyId));
      allow create, update: if isAuthed()
        && request.resource.data.companyId != null
        && isAdminOf(request.resource.data.companyId);
      allow delete: if isAdminOf(resource.data.companyId);
    }

    // users: self-access only, or admins of SAME company can manage
    match /users/{uid} {
      allow read: if isAuthed() && (request.auth.uid == uid || matchesCompany(get(/databases/$(database)/documents/users/$(uid)).data.companyId));
      allow create: if isAuthed() && (
        request.auth.uid == uid ||
        (isAdmin() && request.resource.data.companyId == userCompanyId())
      );
      allow update: if isAuthed() && (
        (request.auth.uid == uid &&
         request.resource.data.companyId == resource.data.companyId &&
         request.resource.data.role == resource.data.role) ||
        (isAdmin() && matchesCompany(resource.data.companyId) && request.resource.data.companyId == resource.data.companyId)
      );
      allow delete: if isAdmin() && matchesCompany(resource.data.companyId);
    }

    // ========================================================================
    // SHARED CATALOGS: Both companies can read and write
    // (villas, cars, boats, chefs, security, services, properties)
    // ========================================================================

    // SHARED CATALOGS: both companies can view the same services (read),
    // but can only write within their own companyId (prevents mixing).
    match /cars/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /villas/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /boats/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /chefs/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /services/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /serviceCategories/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /security/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    match /properties/{id} {
      allow read: if isAuthed();
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateForCompany(resource.data.companyId) ||
        (isAdmin() && resource.data.companyId == null && request.resource.data.companyId == userCompanyId());
      allow delete: if canDeleteForCompany(resource.data.companyId) || (isAdmin() && resource.data.companyId == null);
    }

    // ========================================================================
    // CORE CONCIERGE SERVICE OVERRIDES (company-private)
    // ========================================================================
    match /concierge_core_services/{id} {
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    // ========================================================================
    // COMPANY-PRIVATE DATA: Each company can ONLY access their own
    // (clients, reservations/bookings, offers, expenses, finances)
    // ========================================================================

    match /clients/{id} {
      // List queries MUST filter by companyId in your code: where("companyId", "==", userCompanyId)
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    match /reservations/{id} {
      // List queries MUST filter by companyId in your code: where("companyId", "==", userCompanyId)
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    match /collaborators/{id} {
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    match /offers/{id} {
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    match /expenses/{id} {
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    match /categoryPayments/{id} {
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    // Public property share links (read-only for public)
    match /property_shares/{id} {
      allow read: if resource.data.public == true;
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }

    // Finance records: provider payouts & profit
    match /financeRecords/{id} {
      allow read: if canReadCompanyData(resource.data.companyId);
      allow create: if canCreateForCompany(request.resource.data.companyId);
      allow update: if canUpdateCompanyData(resource.data.companyId);
      allow delete: if canDeleteCompanyData(resource.data.companyId);
    }
  }
}
